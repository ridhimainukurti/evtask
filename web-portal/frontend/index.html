<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EV Community Portal</title>
    <meta name="viewport" content="width=1024">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="static/styles.css">
</head>
<body>
    <h1>EV Community Portal</h1>
    <div id="authSection" class="card auth-card">
        <h3>Register</h3>
        <form id="registerForm">
            <input type="text" id="reguser" placeholder="Username" required>
            <input type="password" id="regpass" placeholder="Password" required>
            <button type="submit" class="btn-main">Register</button>
        </form>
        <h3>Login</h3>
        <form id="loginForm">
            <input type="text" id="loginuser" placeholder="Username" required>
            <input type="password" id="loginpass" placeholder="Password" required>
            <button type="submit" class="btn-main">Login</button>
        </form>
        <div id="userWelcome"></div>
    </div>

    <button id="logoutBtn" class="logout-btn" style="display:none;">Sign Out</button>

    <div id="mainApp" class="card main-card" style="display:none;">
        <div class="composer-card">
            <form id="postForm" class="post-form">
                <input type="text" id="title" placeholder="Title" required>
                <input type="text" id="content" placeholder="Content or Link" required>
                <button type="submit" class="btn-main btn-post">Post</button>
            </form>
            <div class="controls-toolbar">
                <input type="text" id="searchInput" class="search-bar" placeholder="Search posts...">
                <button id="searchBtn" class="btn-main">Search</button>
                <button id="clearSearchBtn" class="btn-ghost">Clear</button>
                <button id="showFavBtn" class="btn-fav"><i class="fa fa-star"></i> Saved</button>
            </div>
        </div>
        <div id="posts"></div>
    </div>
    <script>
        window.userFavorites = [];

        document.getElementById('searchBtn').onclick = function() {
            const term = document.getElementById('searchInput').value.trim();
            loadPosts(term);
        };

        document.getElementById('clearSearchBtn').onclick = function() {
            document.getElementById('searchInput').value = '';
            loadPosts();
        };
        // loading the comments for a particular post 
        function loadComments(postID) {
            fetch(`/api/posts/${postID}/comments`)
                .then(res => res.json())
                .then(comments => {
                    //debug
                    console.log("Loaded comments for post " + postID, comments);
                    const listDiv = document.getElementById(`commentList-${postID}`);
                    listDiv.innerHTML = '';
                    comments.forEach(comment => {
                        const c = document.createElement('div');
                        c.className = 'comment';
                        c.innerHTML = `<b>${comment.user}:</b> ${comment.content}`;
                        listDiv.appendChild(c);
                    });
                });       
        }
        
        // another helper for adding commenting 
        function addComment(event, postId) {
            event.preventDefault();
            const input = document.getElementById(`commentInput-${postId}`);
            const content = input.value;
            const user = localStorage.getItem('username') || 'Anonymous';
            fetch(`/api/posts/${postId}/comments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user, content })
            })
            .then(res => res.json())
            .then(() => {
                loadComments(postId);
                input.value = '';
            });
        }
        // asks for lists of post from backend 
        // has two buttons: upvote & downvote 
        function loadPosts(searchTerm) {
            let url = 'api/posts';
            if (searchTerm) {
                url += '?search=' + encodeURIComponent(searchTerm);
            }

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    const container = document.getElementById('posts');
                    container.innerHTML = '';
                    data.forEach(post => {
                        const div = document.createElement('div');
                        div.className = 'post';
                        const currentUser = localStorage.getItem('username');
                        let isFavorited = false;  
                        if (currentUser && post.id && window.userFavorites) {
                            isFavorited = window.userFavorites.includes(post.id);
                        }
                        div.innerHTML = `
                            <h3>${post.title}</h3>
                            <p>${post.content}</p>
                            <div class="post-meta">
                                <span>Votes: <span id="votes-${post.id}">${post.votes}</span></span>
                                <span>Posted by: 
                                    <a href="#" class="user-link" data-username="${post.user || 'Anonymous'}">
                                        ${post.user || 'Anonymous'}
                                    </a>
                                </span>
                            </div>
                            <div class="vote-group">
                                <button onclick="vote(${post.id}, 'upvote')" class="btn-vote upvote"><i class="fa fa-arrow-up"></i></button>
                                <span class="vote-count" id="votes-${post.id}">${post.votes}</span>
                                <button onclick="vote(${post.id}, 'downvote')" class="btn-vote downvote"><i class="fa fa-arrow-down"></i></button>
                            </div>
                            <button onclick="toggleFavorite(${post.id})" class="btn-fav-big">
                                <i class="fa${isFavorited ? 's' : 'r'} fa-star"></i>
                                ${isFavorited ? 'Saved' : 'Save'}
                            </button>
                            ${localStorage.getItem('username') == 'admin'
                                ? `<button onclick="deletePost(${post.id})" class="btn-delete">Delete</button>`
                                : ''
                            }
                            <div class="comments" id="comments-${post.id}">
                                <strong>Comments:</strong>
                                <div id="commentList-${post.id}"></div>
                                <form id="commentForm-${post.id}" data-post-id="${post.id}">
                                    <input type="text" placeholder="Add a comment" id="commentInput-${post.id}" required />
                                    <button type="submit" class="btn-main btn-comment">Post</button>
                                </form>
                            </div>
                        `;
                        container.appendChild(div);
                        loadComments(post.id);
                    });
                    // Re-add event listeners for user profile links and comment forms, if needed
                    document.querySelectorAll('.user-link').forEach(link => {
                        link.onclick = function(e) {
                            e.preventDefault();
                            const username = link.dataset.username;
                            showUserPosts(username);
                        };
                    });
                    document.querySelectorAll('form[id^="commentForm-"]').forEach(form => {
                        form.onsubmit = function(event) {
                            event.preventDefault();
                            const postId = form.dataset.postId;
                            addComment(event, postId);
                        }
                    });
                });
        }
        //loadPosts();

        // shows the users posts 
        function showUserPosts(username) {
            // Hide the post form
            document.getElementById('postForm').style.display = 'none';

            // Fetch user info first
            fetch(`/api/users/${username}/info`)
                .then(res => res.json())
                .then(userInfo => {
                    // Now fetch the user's posts
                    fetch(`/api/users/${username}/posts`)
                        .then(res => res.json())
                        .then(userPosts => {
                            const container = document.getElementById('posts');
                                const loggedInUser = localStorage.getItem('username');

                                // Build profile header with editable description if current user
                                let profileHtml = `
                                    <button id="backToFeedBtn" class="btn-main btn-ghost">Back to Feed</button>
                                    <h2>Profile: ${userInfo.username}</h2>
                                    <p><b>Joined:</b> ${userInfo.created_at}</p>
                                `;

                                if (loggedInUser === userInfo.username) {
                                    // Show editable description
                                    profileHtml += `
                                        <p><b>Description:</b>
                                            <span id="descText">${userInfo.description}</span>
                                            <button id="editDescBtn">Edit</button>
                                        </p>
                                        <div id="editDescSection" style="display:none;">
                                            <input type="text" id="newDescInput" value="${userInfo.description}" style="width:60%;">
                                            <button id="saveDescBtn">Save</button>
                                            <button id="cancelDescBtn">Cancel</button>
                                        </div>
                                    `;
                                } else {
                                    // Show read-only description for other users
                                    profileHtml += `<p><b>Description:</b> ${userInfo.description}</p>`;
                                }

                                profileHtml += `<h3>Posts by ${username}</h3>`;
                                container.innerHTML = profileHtml;

                                // Render user's posts (keep this the same as before)
                                userPosts.forEach(post => {
                                    const div = document.createElement('div');
                                    div.className = 'post';
                                    div.innerHTML = `
                                        <h3>${post.title}</h3>
                                        <p>${post.content}</p>
                                        <div class="post-meta">
                                            <span>Votes: ${post.votes}</span>
                                            <span>Posted by: ${post.user || 'Anonymous'}</span>
                                        </div>
                                        <div class="comments" id="comments-${post.id}">
                                            <strong>Comments:</strong>
                                            <div id="commentList-${post.id}"></div>
                                        </div>
                                    `;
                                    container.appendChild(div);
                                    loadComments(post.id);
                                });

                                // "Back to Feed" button
                                document.getElementById('backToFeedBtn').onclick = function() {
                                    document.getElementById('postForm').style.display = 'block';
                                    loadPosts();
                                };

                                // Only add these event listeners if viewing own profile
                                if (loggedInUser === userInfo.username) {
                                    // Edit button click
                                    document.getElementById('editDescBtn').onclick = function() {
                                        document.getElementById('descText').style.display = 'none';
                                        document.getElementById('editDescBtn').style.display = 'none';
                                        document.getElementById('editDescSection').style.display = 'inline-block';
                                    };
                                    // Save button click
                                    document.getElementById('saveDescBtn').onclick = function() {
                                        const newDesc = document.getElementById('newDescInput').value;
                                        fetch(`/api/users/${userInfo.username}/description`, {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ description: newDesc })
                                        })
                                        .then(res => res.json())
                                        .then(data => {
                                            document.getElementById('descText').innerText = data.description;
                                            document.getElementById('descText').style.display = 'inline';
                                            document.getElementById('editDescBtn').style.display = 'inline';
                                            document.getElementById('editDescSection').style.display = 'none';
                                        });
                                    };
                                    // Cancel button click
                                    document.getElementById('cancelDescBtn').onclick = function() {
                                        document.getElementById('editDescSection').style.display = 'none';
                                        document.getElementById('descText').style.display = 'inline';
                                        document.getElementById('editDescBtn').style.display = 'inline';
                                    };
                                }
                            });
                    });
        }

        // deletes a post if it is inappropriate
        function deletePost(postID) {
            if (!confirm("Are you sure that you want to delete this post")) return;
            fetch(`/api/posts/${postID}/delete?admin=admin`, {
                method: 'DELETE'
            })
            .then(res => res.json())
            .then(() => {
                loadPosts();
            });
        }

        // sends a POST to backend with post id and action which updates the post's vote count 
        function vote(postID, action) {
            fetch(`/api/posts/${postID}/vote`, {
                method: 'POST', 
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action })
            })
            .then(res => res.json())
            .then(() => {
                // reloads and reorders the posts after every vote
                loadPosts();
            });
        }

        // updates the page to reflect whether user is logged in or not & show/hide sections 
        function updateUserUI() {
            // gets username data 
            const user = localStorage.getItem('username');
            const welcomeDiv = document.getElementById('userWelcome');
            const logoutBtn = document.getElementById('logoutBtn');
            const authSection = document.getElementById('authSection');
            const mainApp = document.getElementById('mainApp');
            // if username is there then display information otherwise remove
            if (user) {
                welcomeDiv.innerText = "Logged in as " + user;
                logoutBtn.style.display = "inline";
                // hide authentication forms & show main content 
                authSection.style.display = "none";
                mainApp.style.display = "block";
                // Fetch and cache favorites when logged in
                fetch(`/api/users/${user}/favorites`)
                    .then(res => res.json())
                    .then(favs => {
                        window.userFavorites = favs.map(p => p.id);
                        loadPosts();
                    });
                return;
            } else {
                welcomeDiv.innerText = "";
                logoutBtn.style.display = "none";
                // show authentication forms & hide main content 
                authSection.style.display = "block";
                mainApp.style.display = "none";
            }
        }

        function toggleFavorite(postId) {
            const user = localStorage.getItem('username');
            if (!user) {
                alert("You need to log in to save posts!");
                return;
            }
            let isFavorite = window.userFavorites && window.userFavorites.includes(postId);
            let method = isFavorite ? 'DELETE' : 'POST';
            fetch(`/api/users/${user}/favorites/${postId}`, { method })
                .then(res => res.json())
                .then(() => {
                    // Update favorites, then reload posts (respecting search filter)
                    fetch(`/api/users/${user}/favorites`)
                        .then(res => res.json())
                        .then(favs => {
                            window.userFavorites = favs.map(p => p.id);
                            loadPosts(document.getElementById('searchInput').value.trim());
                        });
                });
        }

        // handles registration 
        document.getElementById('registerForm').addEventListener('submit', function(e) {
            // gets the input fields and sends a request to create a new user
            e.preventDefault();
            const username = document.getElementById('reguser').value;
            const password = document.getElementById('regpass').value;
            fetch('/api/register', {
                method: 'POST',
                headers: {'Content-type': 'application/json'},
                body: JSON.stringify({ username, password })
            })
            // gets confirmation that user is registered and resets form 
            .then(res => res.json())
            .then(data => {
                alert(data.message || data.error);
                document.getElementById('registerForm').reset();
            });
        });

        // handles login 
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            // stops reloading of papge and reads input fields
            e.preventDefault(); 
            const username = document.getElementById('loginuser').value;
            const password = document.getElementById('loginpass').value;
            // sends a request and saves logged in user in local storage
            fetch('/api/login', {
                method: 'POST',
                headers: {'Content-type': 'application/json'},
                body: JSON.stringify({ username, password })
            })
            .then(res => res.json())
            .then(data => {
                if (data.username) {
                    localStorage.setItem('username', data.username);
                    //document.getElementById('userWelcome').innerText = "Logged in as " + data.username;
                    updateUserUI();
                } else {
                    alert(data.error);
                }
                document.getElementById('loginForm').reset();
            });
        });

        // show if user is logged in already 
        /*if (localStorage.getItem('username')) {
            document.getElementById('userWelcome').innerText = "Logged in as " + localStorage.getItem('username');
        }*/
       updateUserUI();

        // listens when user submits a post form 
        document.getElementById('postForm').addEventListener('submit', function(e) {
            e.preventDefault();
            // stops default form action, grabs input values and sends them as a new post (backend)
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            const user = localStorage.getItem('username') || 'Anonymous';
            fetch('api/posts', {
                method: 'POST', 
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({title, content, user})
            })
            // refreshes post feed and clears form 
            .then((res => res.json()))
            .then(() => {
                loadPosts();
                document.getElementById('postForm').reset();
            });
        });

        // sign out button when clicked will remove the logged in message
        document.getElementById('logoutBtn').addEventListener('click', function() {
            localStorage.removeItem('username');
            updateUserUI();
        });

        document.getElementById('showFavBtn').onclick = function() {
            const user = localStorage.getItem('username');
            if (!user) {
                alert("Log in to see saved posts!");
                return;
            }
            fetch(`/api/users/${user}/favorites`)
                .then(res => res.json())
                .then(posts => {
                    const container = document.getElementById('posts');
                    container.innerHTML = "<h2>Saved Posts</h2>";
                    posts.forEach(post => {
                        const div = document.createElement('div');
                        div.className = 'post';
                        div.innerHTML = `
                            <h3>${post.title}</h3>
                            <p>${post.content}</p>
                            <div class="post-meta">
                                <span>Votes: <span id="votes-${post.id}">${post.votes}</span></span>
                                <span>Posted by: 
                                    <a href="#" class="user-link" data-username="${post.user || 'Anonymous'}">
                                        ${post.user || 'Anonymous'}
                                    </a>
                                </span>
                            </div>
                            <button onclick="toggleFavorite(${post.id})" class="fav-btn" style="margin-left:10px;">
                                ★ Saved
                            </button>
                            <div class="comments" id="comments-${post.id}">
                                <strong>Comments:</strong>
                                <div id="commentList-${post.id}"></div>
                                <form id="commentForm-${post.id}" data-post-id="${post.id}">
                                    <input type="text" placeholder="Add a comment" id="commentInput-${post.id}" required />
                                    <button type="submit">Post</button>
                                </form>
                            </div>
                        `;
                        container.appendChild(div);
                        loadComments(post.id);
                    });
                });
        };  
    </script>
</body>
</html>